<?php

namespace App\Services;

use App\Interfaces\ExchangeServiceInterface;

class ExchangeService implements ExchangeServiceInterface {
    private $baseUrl;
    private $apiKey;

    public function __construct() {
        $this->baseUrl = $_ENV['EXCHANGE_RATES_URL'] ?? 'http://api.exchangeratesapi.io/latest';
        $this->apiKey = $_ENV['API_KEY'];
    }

    public function getRate($currency) {
        $url = "{$this->baseUrl}?access_key={$this->apiKey}";
        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HEADER, false);
        $response = curl_exec($ch);
        curl_close($ch);
        if (!$response) {
            throw new \Exception("Error fetching exchange rates.");
        }

        // $response = '{"success":true,"timestamp":1718000163,"base":"EUR","date":"2024-06-10","rates":{"AED":3.950062,"AFN":76.573244,"ALL":100.354252,"AMD":422.117885,"ANG":1.962483,"AOA":920.030319,"ARS":966.996619,"AUD":1.630815,"AWG":1.938464,"AZN":1.82701,"BAM":1.955883,"BBD":2.198593,"BDT":127.895419,"BGN":1.947267,"BHD":0.410417,"BIF":3128.732562,"BMD":1.075431,"BND":1.465162,"BOB":7.524319,"BRL":5.692955,"BSD":1.088946,"BTC":1.5458626e-5,"BTN":90.848049,"BWP":14.967634,"BYN":3.563051,"BYR":21078.439078,"BZD":2.194893,"CAD":1.479653,"CDF":3041.318007,"CHF":0.964785,"CLF":0.035831,"CLP":988.686002,"CNY":7.794503,"CNH":7.815798,"COP":4292.183192,"CRC":575.524385,"CUC":1.075431,"CUP":28.49891,"CVE":110.269672,"CZK":24.657496,"DJF":193.878214,"DKK":7.460289,"DOP":64.652739,"DZD":144.628577,"EGP":51.284372,"ERN":16.131458,"ETB":62.621053,"EUR":1,"FJD":2.412402,"FKP":0.856149,"GBP":0.845654,"GEL":3.038104,"GGP":0.856149,"GHS":16.197686,"GIP":0.856149,"GMD":72.887277,"GNF":9377.397314,"GTQ":8.461359,"GYD":227.819653,"HKD":8.401941,"HNL":26.90414,"HRK":7.506458,"HTG":144.44612,"HUF":391.609418,"IDR":17519.57048,"ILS":4.031575,"IMP":0.856149,"INR":89.793087,"IQD":1426.460438,"IRR":45275.626424,"ISK":149.710693,"JEP":0.856149,"JMD":169.277172,"JOD":0.762266,"JPY":168.925348,"KES":140.956844,"KGS":93.88649,"KHR":4476.189653,"KMF":486.578519,"KPW":967.887183,"KRW":1479.926922,"KWD":0.329749,"KYD":0.907438,"KZT":487.430652,"LAK":23487.99517,"LBP":97512.931554,"LKR":329.623966,"LRD":211.198948,"LSL":20.594673,"LTL":3.175467,"LVL":0.650517,"LYD":5.265223,"MAD":10.747555,"MDL":19.224815,"MGA":4824.204398,"MKD":61.573067,"MMK":2950.826224,"MNT":3710.235206,"MOP":8.758871,"MRU":42.903818,"MUR":50.110295,"MVR":16.573273,"MWK":1888.079997,"MXN":19.69821,"MYR":5.073344,"MZN":68.30061,"NAD":20.594673,"NGN":1615.630002,"NIO":40.081698,"NOK":11.548831,"NPR":145.357159,"NZD":1.760614,"OMR":0.413988,"PAB":1.088946,"PEN":4.093173,"PGK":4.181177,"PHP":63.241232,"PKR":302.828931,"PLN":4.312267,"PYG":8201.347485,"QAR":3.972068,"RON":4.977308,"RSD":117.109013,"RUB":95.702225,"RWF":1415.959993,"SAR":4.032543,"SBD":9.122343,"SCR":14.839828,"SDG":630.202279,"SEK":11.370156,"SGD":1.455547,"SHP":1.358753,"SLE":24.570688,"SLL":22551.242248,"SOS":622.326368,"SRD":34.056713,"STD":22259.241415,"SVC":9.528404,"SYP":2702.051402,"SZL":20.589872,"THB":39.648431,"TJS":11.689595,"TMT":3.774761,"TND":3.373543,"TOP":2.541352,"TRY":34.786377,"TTD":7.371312,"TWD":34.889088,"TZS":2829.947119,"UAH":43.787055,"UGX":4127.174865,"USD":1.075431,"UYU":42.561803,"UZS":13785.584085,"VEF":3895803.719677,"VES":39.902971,"VND":27339.595829,"VUV":127.677257,"WST":3.014532,"XAF":655.984794,"XAG":0.036366,"XAU":0.000469,"XCD":2.906405,"XDR":0.822835,"XOF":655.984794,"XPF":119.331742,"YER":269.314701,"ZAR":20.248261,"ZMK":9680.168423,"ZMW":28.720217,"ZWL":346.288203}}';
        
        $data = json_decode($response, true);

        return $data['rates'][$currency] ?? 0;
    }
}
